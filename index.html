<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Test Script</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        .test-box {
            background: #000;
            border: 1px solid #0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .pass { color: #0f0; }
        .fail { color: #f00; }
        .warn { color: #ff0; }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 3px;
        }
        button:hover { background: #0d0; }
        .result { margin-top: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üîß KASIR FUNCTIONALITY TEST</h1>
    
    <div class="test-box">
        <h2>1Ô∏è‚É£ Test Environment</h2>
        <button onclick="testEnvironment()">Run Test</button>
        <div id="envResult" class="result"></div>
    </div>

    <div class="test-box">
        <h2>2Ô∏è‚É£ Test QRIS Image</h2>
        <button onclick="testQRISImage()">Run Test</button>
        <div id="qrisResult" class="result"></div>
        <canvas id="testCanvas" width="300" height="300" style="border: 1px solid #0f0; margin-top: 10px; display: none;"></canvas>
    </div>

    <div class="test-box">
        <h2>3Ô∏è‚É£ Test API Connection</h2>
        <input type="text" id="apiUrl" placeholder="http://localhost:8000" 
               style="width: 300px; padding: 5px; background: #000; color: #0f0; border: 1px solid #0f0;">
        <button onclick="testAPIConnection()">Run Test</button>
        <div id="apiResult" class="result"></div>
    </div>

    <div class="test-box">
        <h2>4Ô∏è‚É£ Test Transaction Data</h2>
        <button onclick="testTransactionData()">Run Test</button>
        <div id="transactionResult" class="result"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script>
        function log(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            const colors = {
                pass: 'class="pass"',
                fail: 'class="fail"',
                warn: 'class="warn"',
                info: ''
            };
            el.innerHTML += `<div ${colors[type]}>${message}</div>`;
        }

        function clear(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // Test 1: Environment
        function testEnvironment() {
            clear('envResult');
            log('envResult', 'üîç Testing environment...', 'info');
            
            // Check browser
            log('envResult', '‚úì Browser: ' + navigator.userAgent.split(' ').pop(), 'pass');
            
            // Check localStorage
            try {
                localStorage.setItem('test', '1');
                localStorage.removeItem('test');
                log('envResult', '‚úì LocalStorage: Available', 'pass');
            } catch (e) {
                log('envResult', '‚úó LocalStorage: Not available - ' + e.message, 'fail');
            }

            // Check fetch API
            if (typeof fetch === 'function') {
                log('envResult', '‚úì Fetch API: Available', 'pass');
            } else {
                log('envResult', '‚úó Fetch API: Not available', 'fail');
            }

            // Check Canvas
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    log('envResult', '‚úì Canvas: Available', 'pass');
                } else {
                    log('envResult', '‚úó Canvas: Context not available', 'fail');
                }
            } catch (e) {
                log('envResult', '‚úó Canvas: Not available - ' + e.message, 'fail');
            }

            // Check jsQR
            if (typeof jsQR === 'function') {
                log('envResult', '‚úì jsQR Library: Loaded', 'pass');
            } else {
                log('envResult', '‚úó jsQR Library: Not loaded', 'fail');
            }

            log('envResult', '\nüìä Environment test completed!', 'info');
        }

        // Test 2: QRIS Image
        function testQRISImage() {
            clear('qrisResult');
            log('qrisResult', 'üîç Testing QRIS image...', 'info');

            const qrisUrl = prompt('Enter QRIS image URL:', 'http://localhost:8000/qris.jpeg');
            if (!qrisUrl) {
                log('qrisResult', '‚úó Test cancelled', 'warn');
                return;
            }

            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = () => {
                log('qrisResult', '‚úì Image loaded successfully', 'pass');
                log('qrisResult', `  Size: ${img.width}x${img.height}px`, 'info');

                // Try to read QR
                const canvas = document.getElementById('testCanvas');
                canvas.style.display = 'block';
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                try {
                    const imageData = ctx.getImageData(0, 0, img.width, img.height);
                    log('qrisResult', '‚úì Canvas not tainted (CORS OK)', 'pass');

                    const qr = jsQR(imageData.data, img.width, img.height);
                    if (qr) {
                        log('qrisResult', '‚úì QR Code detected!', 'pass');
                        log('qrisResult', `  Data length: ${qr.data.length} chars`, 'info');
                        log('qrisResult', `  Preview: ${qr.data.substring(0, 50)}...`, 'info');
                        
                        // Check EMV format
                        if (qr.data.startsWith('00020')) {
                            log('qrisResult', '‚úì EMV QR format detected', 'pass');
                        } else {
                            log('qrisResult', '‚ö† Not EMV format, might not work', 'warn');
                        }
                    } else {
                        log('qrisResult', '‚úó No QR Code detected in image', 'fail');
                        log('qrisResult', '  Make sure the image contains a valid QR code', 'warn');
                    }
                } catch (e) {
                    log('qrisResult', '‚úó Canvas tainted (CORS error)', 'fail');
                    log('qrisResult', '  Error: ' + e.message, 'fail');
                    log('qrisResult', '  Solution: Make sure image is served via HTTP (not file://)', 'warn');
                }
            };

            img.onerror = (e) => {
                log('qrisResult', '‚úó Failed to load image', 'fail');
                log('qrisResult', '  URL: ' + qrisUrl, 'info');
                log('qrisResult', '  Check if file exists and path is correct', 'warn');
            };

            img.src = qrisUrl;
        }

        // Test 3: API Connection
        async function testAPIConnection() {
            clear('apiResult');
            log('apiResult', 'üîç Testing API connection...', 'info');

            const baseUrl = document.getElementById('apiUrl').value || 'http://localhost:8000';
            const endpoint = baseUrl + '/kasir/store';

            log('apiResult', `Testing: ${endpoint}`, 'info');

            try {
                // Test OPTIONS (CORS preflight)
                log('apiResult', '\n1. Testing CORS preflight...', 'info');
                const optionsRes = await fetch(endpoint, { method: 'OPTIONS' });
                log('apiResult', `  Status: ${optionsRes.status}`, optionsRes.ok ? 'pass' : 'warn');

                // Test POST with invalid data
                log('apiResult', '\n2. Testing POST endpoint...', 'info');
                const postRes = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ test: 'data' })
                });

                log('apiResult', `  Status: ${postRes.status}`, 'info');
                
                if (postRes.status === 419) {
                    log('apiResult', '  ‚úó CSRF token missing (expected in browser)', 'warn');
                } else if (postRes.status === 422) {
                    log('apiResult', '  ‚úì Endpoint reachable (validation error expected)', 'pass');
                } else if (postRes.status === 500) {
                    log('apiResult', '  ‚ö† Server error, check Laravel logs', 'warn');
                } else {
                    log('apiResult', `  Response status: ${postRes.status}`, 'info');
                }

                const data = await postRes.json();
                log('apiResult', `  Response: ${JSON.stringify(data, null, 2)}`, 'info');

            } catch (e) {
                log('apiResult', '‚úó Connection failed', 'fail');
                log('apiResult', `  Error: ${e.message}`, 'fail');
                log('apiResult', '\nPossible causes:', 'warn');
                log('apiResult', '  - Laravel server not running', 'warn');
                log('apiResult', '  - Wrong URL', 'warn');
                log('apiResult', '  - CORS not configured', 'warn');
            }
        }

        // Test 4: Transaction Data
        function testTransactionData() {
            clear('transactionResult');
            log('transactionResult', 'üîç Testing transaction data format...', 'info');

            const sampleData = {
                total_harga: 50000,
                total_bayar: 55000,
                metode: 'Tunai',
                barang: [
                    {
                        id_barang: 1,
                        jumlah_kardus: 2,
                        jumlah_ecer: 5,
                        harga_kardus: 10000,
                        harga_ecer: 2000,
                        subtotal: 30000
                    }
                ]
            };

            log('transactionResult', 'Sample transaction data:', 'info');
            log('transactionResult', JSON.stringify(sampleData, null, 2), 'info');

            // Validate structure
            log('transactionResult', '\nValidating structure...', 'info');
            
            if (typeof sampleData.total_harga === 'number') {
                log('transactionResult', '‚úì total_harga: number', 'pass');
            } else {
                log('transactionResult', '‚úó total_harga: not a number', 'fail');
            }

            if (typeof sampleData.total_bayar === 'number') {
                log('transactionResult', '‚úì total_bayar: number', 'pass');
            } else {
                log('transactionResult', '‚úó total_bayar: not a number', 'fail');
            }

            if (['Tunai', 'Qris'].includes(sampleData.metode)) {
                log('transactionResult', '‚úì metode: valid', 'pass');
            } else {
                log('transactionResult', '‚úó metode: invalid', 'fail');
            }

            if (Array.isArray(sampleData.barang) && sampleData.barang.length > 0) {
                log('transactionResult', '‚úì barang: array with items', 'pass');
            } else {
                log('transactionResult', '‚úó barang: empty or not array', 'fail');
            }

            // Validate barang items
            sampleData.barang.forEach((item, i) => {
                log('transactionResult', `\nItem ${i + 1}:`, 'info');
                const required = ['id_barang', 'jumlah_kardus', 'jumlah_ecer', 'subtotal'];
                required.forEach(field => {
                    if (item[field] !== undefined) {
                        log('transactionResult', `  ‚úì ${field}: ${item[field]}`, 'pass');
                    } else {
                        log('transactionResult', `  ‚úó ${field}: missing`, 'fail');
                    }
                });
            });

            log('transactionResult', '\nüìä Validation completed!', 'info');
        }

        // Auto-run environment test on load
        window.onload = () => {
            testEnvironment();
        };
    </script>
</body>
</html>